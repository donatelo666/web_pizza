<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Registro y contacto</title>
    <!--union con el css, fuentes de google , bootstrap-->
    <link rel="stylesheet" href="/front/public/estilo_contacto.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Lemon&family=Sigmar&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB"
      crossorigin="anonymous"
    />
    <!--color de fondo-->
    <style>
      body {
        background-color: #dd9c52;
      }
    </style>
  </head>

  <body>
    <!--header con css-->
    <header class="head">
      <p>Contacto, registro y login<br />para ordenar pizzas</p>
    </header>
    <!--seccion que contiene un texto con css-->
    <section class="horario">
      <p class="texto2">Horario: viernes, sabado y domingo 4 a 11 pm.</p>
    </section>
    <!-- formulario de registro en la web de pizzas con input , nombre , sugerencias de texto
     obligatorio de campos y boton -->
    <form id="registroForm">
      <h3>Registro en TMNT</h3>
      <input
        type="text"
        name="nombre"
        placeholder="Minimo 4 y maximo 20 caracteres"
        required
        pattern="[A-Za-z0-9]{4,20}"
      />
      <input
        type="password"
        name="password"
        placeholder="Minimo 4 y maximo 15 caracteres"
        required
        pattern="[A-Za-z0-9]{4,15}"
      />
      <button type="submit">Registrarse</button>
    </form>
    <!--script que recibe elementos de formulario anterior, con el evento del boton
    submit, previene el revargar pagina "e.preventdefault"-->
    <script>
      const sanitize = (str) => str.replace(/[<>"'`]/g, "");
      function mostrarNotificacion() {
        const mensaje = `‚úÖ Registro de usuario completado con √©xito<br> ahora puedes hacer login y ordenar`;
        const notificacion = document.getElementById("notificacion");
        notificacion.innerHTML = mensaje;
        notificacion.classList.remove("oculto"); //quita el oculto del div que contiene la notificaion
        notificacion.classList.add("visible"); // define funcion que muestra una notificacion
        //  con estilos
        //mensaje para el usuario , la pone en modo "visible"

        // Ocultar despu√©s de 25 segundos , remueve visible despues de 25 segundos y pone oculto
        // a la notificacion
        setTimeout(() => {
          notificacion.classList.remove("visible");
          notificacion.classList.add("oculto");
        }, 25000);
      }

      document
        .getElementById("registroForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const formData = new FormData(e.target); // define la informacion del usuario como data
          const data = {
            nombre: formData.get("nombre"),
            password: formData.get("password"),
          };

          const res = await fetch("http://localhost:3000/register", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data),
          }); // usa la api post de register y transforma los datos en un jason

          const result = await res.json();
          if (res.ok) {
            mostrarNotificacion(); // ejecuta la funcion y muestra la notificacion
          } else {
            alert(result.error || "Error al registrar");
          }
        });
    </script>
    <!--pone la notificaion en oculto que despues se activa a modo visible para formulario de ordenar -->
    <div id="notificacion" class="oculto"></div>
    <!-- formulario para logearse con nombre y password, ambos campos requeridos y boton submit
     tiene placeholder -->
    <form id="loginForm">
      <h3>Login para ordenar</h3>
      <input
        type="text"
        name="nombre"
        placeholder="Nombre"
        required
        pattern="[A-Za-z0-9]{4,20}"
      />
      <input
        type="password"
        name="password"
        placeholder="Contrase√±a"
        pattern="[A-Za-z0-9]{4,15}"
        required
      />
      <button type="submit">Entrar</button>
    </form>
    <!--formulario que recibe datos del evento submit , previene la recarga, tranforma 
    la info en "data"-->
    <script>
      const sanitize2 = (str) => str.replace(/[<>"'`]/g, "");

      function mostrarNotificacion2() {
        //mensaje para el usuario , la pone en modo "visible"
        const mensaje = `‚úÖ Bienvenido <br>
    Has iniciado sesi√≥n correctamente.<br><br>
    Ser√°s redirigido a la p√°gina de ordenes en unos segundos...<br><br>
    <button id="btnIrEditar" class="btn btn-light">Ir ahora</button>`;
        const notificacion = document.getElementById("notificacion2");
        notificacion.innerHTML = mensaje;
        notificacion.classList.remove("oculto"); //quita el oculto del div que contiene la notificaion
        notificacion.classList.add("visible"); // define funcion que muestra una notificacion
        //  con estilos
      }

      document
        .getElementById("loginForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const formData = new FormData(e.target);
          const data = {
            nombre: formData.get("nombre"),
            password: formData.get("password"),
          };

          const res = await fetch("http://localhost:3000/login", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data),
          }); // usa la api post de login y tranforma data en un jason
          const result = await res.json();
          if (res.ok && result.token) {
            localStorage.setItem("token", result.token); //confirma el login exitoso del jason y le da un token al usuario
            mostrarNotificacion2(); // ejecuta la funcion y muestra la notificacion

            //redirige a la siguiente pagina si el usuario espera
            const redireccion = setTimeout(() => {
              window.location.href = "/front/views/editar.html";
            }, 10000);
            // üß≠ Redirige inmediatamente si el usuario hace clic en el bot√≥n
            document
              .getElementById("btnIrEditar")
              .addEventListener("click", () => {
                clearTimeout(redireccion); // cancela el temporizador
                window.location.href = "/front/views/editar.html";
              });
          } else {
            alert(result.error || "Error al iniciar sesi√≥n");
          }
        });
    </script>
    <!--pone la notificaion en oculto que despues se activa a modo visible para formulario de ordenar -->
    <div id="notificacion2" class="oculto"></div>
    <!--tarjeta con estilos que contiene un texto e imagen con link a wapp , usa archivo css-->

    <div class="container mt-5">
      <div
        class="card mb-3 border-0 fondo-personalizado"
        style="background-color: #59ca68"
      >
        <div class="row g-0">
          <div class="col-md-8">
            <div class="card-body">
              <h2 class="card-text text-center">
                <br />Escribenos por whatsapp
              </h2>
            </div>
          </div>
          <div class="col-md-4">
            <a
              href="https://whatsapp.com"
              target="_blank"
              rel="noopener noreferrer"
            >
              <img src="/front/public/wapp.png" alt="boton wapp" class="wapp" />
            </a>
          </div>
        </div>
      </div>
    </div>

    <!--footer con dos botones que tiene estilos de css-->
    <footer class="footer_contacto">
      <a href="/front/views/inicio.html" class="inicio-btn">INICIO</a>
      <a href="/front/views/menu.html" class="menu-btn">MENU</a>
    </footer>
    <!--estilo que da color de fondo a la tarjeta con texto e imagen de wapp-->
    <style>
      .fondo-personalizado {
        background-color: #59ca68;
      }
    </style>
    <!--bootstrap-->
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI"
      crossorigin="anonymous"
    ></script>
    <div id="notificacion2" class="oculto"></div>
  </body>
</html>
